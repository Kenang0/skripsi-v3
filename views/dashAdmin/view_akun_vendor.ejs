<style>
  #tabelVendor {
    font-size: 14px;

  }

  .btn-kecil {
    font-size: 0.75rem !important;
    padding: 2px 8px !important;
  }

  .kotak-tabel {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    padding-bottom: 20px;
  }

  .kotak-header {
    background-color: #c9c6c6ad;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
  }

  .kotak-header h5 {
    margin: 0;
  }

  .p-3 {
    flex-grow: 1;
    overflow-x: auto;
  }
</style>

<div class="tabel-vendor">
  <div class="kotak-tabel">
    <div class="kotak-header">
      <h5>PKS Selesai / Di Tolak </h5>

    </div>
    <div class="p-3">
      <table class="table table-bordered" id="tabelVendor">
        <thead class="table-primary">
          <tr>
            <th>No</th>
            <th>Nama PT</th>
            <th>Nama Toko</th>
            <th>Email</th>
            <th>No Telepon</th>
            <th>Akun Dibuat</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          <% data.forEach((v, index)=> { %>
            <tr>
              <td>
                <%= index + 1 %>
              </td>
              <td>
                <%= v.pt_mitra %>
              </td>
              <td>
                <%= v.nama_toko_vendor %>
              </td>
              <td>
                <%= v.email_vendor %>
              </td>
              <td>
                <%= v.no_telepon_vendor %>
              </td>
              <td>
                <%= new Date(v.vendor_dibuat_tanggal).toLocaleDateString('id-ID') %>
              </td>
              <td>
                <%= v.status %>
              </td>
              <td>
                <button type="button" class="btn btn-sm btn-primary btn-edit-vendor btn-kecil"
                  data-id="<%= v.id_vendor %>" data-pt="<%= v.pt_mitra %>" data-toko="<%= v.nama_toko_vendor %>"
                  data-email="<%= v.email_vendor %>" data-tlp="<%= v.no_telepon_vendor %>"
                  data-status="<%= v.status %>">
                  Edit
                </button>
                <!-- <button class="btn btn-sm btn-danger btn-delete-vendor btn-kecil" data-id="<%= v.id_vendor %>">Delete</button> -->
                <button type="button" class="btn btn-warning btn-kecil btn-reset-password" data-id="<%= v.id_vendor %>"
                  data-email="<%= v.email_vendor %>">
                  Email Reset Password
                </button>
              </td>
            </tr>
            <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Modal Edit Vendor -->
<div class="modal fade" id="modalEditVendor" tabindex="-1" aria-labelledby="modalEditVendorLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="formEditVendor" method="POST" action="/admin/dashboardAdmin/update-vendor">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="modalEditVendorLabel">Edit Data Vendor</h5>
            <small id="pt_mitra_label" class="text-muted d-block mt-1" style="font-size: 0.875rem;"></small>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id_vendor" id="edit_id_vendor">
          <div class="mb-3">
            <label for="edit_nama_toko" class="form-label">Nama Toko</label>
            <input type="text" class="form-control" id="edit_nama_toko" name="nama_toko_vendor" required>
          </div>
          <div class="mb-3">
            <label for="edit_email" class="form-label">Email</label>
            <input type="email" class="form-control" id="edit_email" name="email_vendor" required>
          </div>
          <div class="mb-3">
            <label for="edit_telepon" class="form-label">No Telepon</label>
            <input type="text" class="form-control" id="edit_telepon" name="no_telepon_vendor" required>
          </div>
          <div class="mb-3">
            <label for="edit_status" class="form-label">Status</label>
            <select class="form-select" id="edit_status" name="status">
              <option value="aktif">Aktif</option>
              <option value="nonaktif">Nonaktif</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>


  $(document).ready(() => {
    $('#tabelVendor').DataTable({
      pageLength: 5,
      lengthMenu: [5, 10, 25, 50]
    });
  });

  document.querySelectorAll('.btn-edit-vendor').forEach(button => {
    button.addEventListener('click', function () {
      document.getElementById('edit_id_vendor').value = this.dataset.id;

      document.getElementById('edit_nama_toko').value = this.dataset.toko;
      document.getElementById('edit_email').value = this.dataset.email;
      document.getElementById('edit_telepon').value = this.dataset.tlp;
      document.getElementById('edit_status').value = this.dataset.status.toLowerCase();
      document.getElementById('pt_mitra_label').innerText = `PT Mitra: ${this.dataset.pt}`;

      new bootstrap.Modal(document.getElementById('modalEditVendor')).show();
    });
  });



  document.querySelectorAll('.btn-reset-password').forEach(button => {
    button.addEventListener('click', function () {
      const emailVendor = this.dataset.email;

      Swal.fire({
        title: 'Kirim Email Reset Password?',
        text: `Email akan dikirim ke: ${emailVendor}`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Ya, kirim!',
        cancelButtonText: 'Batal',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch('/admin/dashboardAdmin/forgot-password-vendor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: emailVendor })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire('Berhasil', data.message, 'success');
              } else {
                Swal.fire('Gagal', data.message || 'Gagal mengirim email', 'error');
              }
            })
            .catch(() => {
              Swal.fire('Error', 'Terjadi kesalahan saat mengirim request', 'error');
            });
        }
      });
    });
  });

  // belom ada controller handel delete 
  document.querySelectorAll('.btn-delete-vendor').forEach(button => {
    button.addEventListener('click', function () {
      const vendorId = this.dataset.id;

      Swal.fire({
        title: 'Hapus Vendor?',
        text: "Data vendor akan dihapus secara permanen!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Ya, hapus!',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/admin/dashboardAdmin/delete-vendor/${vendorId}`, {
            method: 'DELETE'
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire('Berhasil', data.message, 'success')
                  .then(() => location.reload());
              } else {
                Swal.fire('Gagal', data.message || 'Gagal menghapus vendor', 'error');
              }
            })
            .catch(() => {
              Swal.fire('Error', 'Terjadi kesalahan saat menghapus vendor.', 'error');
            });
        }
      });
    });
  });
</script>
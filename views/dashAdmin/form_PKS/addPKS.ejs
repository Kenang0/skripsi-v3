<link rel="stylesheet" href="/css/dashAdmin/progressbar.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />


<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />



<!-- <link rel="stylesheet" href="/css/progressbar.css" /> -->
<style>
    .checkbox-kategori label {
        font-size: 12px;
        /* atau coba 12px jika kamu mau fix size */
    }

    .checkbox-kategori input[type="checkbox"] {
        transform: scale(0.9);
        /* biar kotak ceklist-nya juga ikut kecil */
        margin-right: 5px;
    }

 /* Samakan tampilan Select2 dengan Bootstrap 5 input */
  .select2-container--default .select2-selection--single {
    height: calc(2.25rem + 2px); /* sama seperti input.form-control */
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #212529;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    margin-top: 10px; 
  }

  .select2-selection__rendered {
    line-height: 1.5 !important;
  }

  .select2-selection__arrow {
    height: calc(2.25rem + 2px);
    top: 0px;
    right: 10px;
  }

  .select2-container--default .select2-selection--single:focus,
  .select2-container--default .select2-selection--single:focus-visible {
    border-color: #86b7fe;
    outline: 0;
  }

  .select2-selection__arrow b {
  display: none; /* sembunyikan panah default */
}

.select2-selection--single::after {
  content: '\f078'; /* kode panah FontAwesome (fa-chevron-down) */
  font-family: "Font Awesome 6 Free";
  font-weight: 900;
   font-size: 0.75rem;
  position: absolute;
  right: 10px;
  top: 58%;
  transform: translateY(-50%);
  pointer-events: none;
}


    .select2-container {
    width: 100% !important;
  }
</style>

<div class="progress-wrapper">
    <div class="progress-container">
        <div class="progress" id="progress"></div>

        <div class="progress-step">
            <div class="progress-icon">
                <i class="fa-solid fas fa-pen-to-square active"></i>
            </div>
            <p class="progress-text">Pembuatan PKS</p>
        </div>

        <div class="progress-step">
            <div class="progress-icon">
                <i class="fa-solid fas fa-upload"></i>
            </div>
            <p class="progress-text">Upload PKS</p>
        </div>

        <div class="progress-step">
            <div class="progress-icon">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            <p class="progress-text">Pengecekan PKS</p>
        </div>

        <div class="progress-step">
            <div class="progress-icon">
                <i class="fa-solid fa-user-plus"></i>
            </div>
            <p class="progress-text">Pembuatan Akun</p>
        </div>

        <div class="progress-step">
            <div class="progress-icon">
                <i class="fa-solid fa-thumbs-up"></i>
            </div>
            <p class="progress-text">Selesai</p>
        </div>
    </div>

    <div class="form-container">
        <form id="multiStepForm" action="#" method="POST" enctype="application/x-www-form-urlencoded">

            <div class="form-step active">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nomor_pks">Nomor PKS: <span style="color:red">*</span></label>
                        <input type="text" id="nomor_pks" name="nomor_pks" placeholder="Masukkan Nomor PKS"
                            class="small-input">
                    </div>
                    <div class="form-group">
                        <label for="hari">Hari: <span style="color:red">* </span></label>
                        <select id="hari" name="hari">
                            <option value="">Pilih Hari</option>
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                            <option value="Sabtu">Sabtu</option>
                            <option value="Minggu">Minggu</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tanggal">Tanggal: <span style="color:red">* </span></label>
                        <input type="date" id="tanggal" name="tanggal">
                    </div>
                    <div class="form-group">
                        <label for="pt_mitra">PT Mitra: <span style="color:red">* </span></label>
                        <input type="text" id="pt_mitra" name="pt_mitra" placeholder="Masukkan Nama PT Mitra"
                            class="large-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="kota">Kota: <span style="color:red">* </span></label>
                        <select id="kota" name="kota" class="small-input">
                            <option value="">Pilih Kota</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nik">NIK: </label>
                        <input type="text" id="nik" name="nik" placeholder="Masukkan NIK Perwakilan"
                            class="small-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pihak_mitra">Perwakilan dari Mitra: <span style="color:red">* </span></label>
                        <input type="text" id="pihak_mitra" name="pihak_mitra" placeholder="Masukkan Nama Perwakilan"
                            class="large-input">
                    </div>
                    <div class="form-group">
                        <label for="jabatan">Jabatan: <span style="color:red">* </span></label>
                        <input type="text" id="jabatan" name="jabatan" placeholder="Masukkan Jabatan Mitra"
                            class="small-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="margin-top: -10px;">
                        <label>Kategori Kerja Sama <span style="color:red">* </span></label><span id="kategori-error"
                            style="color: red; font-size: 12px; display: none;">
                            *Minimal memilih 1
                        </span>

                        <div class="form-row checkbox-kategori">
                            <div>
                                <label><input type="checkbox" name="kategori[]" value="Event"> Event</label>
                                <label><input type="checkbox" name="kategori[]" value="Digital-Production">Digital
                                    Production</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="kategori[]" value="Pasar"> Pasar</label>
                                <label><input type="checkbox" name="kategori[]" value="Digital-Marketing"> Digital
                                    Marketing</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="kategori[]" value="Influencer"> Influencer</label>
                                <label><input type="checkbox" name="kategori[]" value="Messaging"> Messaging</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="kategori[]" value="Radio"> Radio</label>
                                <label><input type="checkbox" name="kategori[]&DOOH" value="OOH&DOOH"> OOH&DOOH</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="kategori[]" value="Influencer"> Influencer</label>
                                <label><input type="checkbox" name="kategori[]" value="Messaging"> Messaging</label>
                            </div>

                            <label><input type="checkbox" name="kategori[]" value="TV"> TV</label>

                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: -40px;">
                    <label for="alamat_pks">Alamat: <span style="color:red">* </span></label>
                    <input type="text" id="alamat_pks" name="alamat_pks" placeholder="Masukkan Alamat Kantor Mitra"
                        class="large-input">
                </div>

                <div class="btn-container">
                    <!-- Tombol untuk preview & download -->
                    <button id="previewButton" formaction="/admin/dashboardAdmin/preview-pks" class="btn">Lihat
                        Preview</button>
                    <button id="downloadButton" disabled class="btn btn-primary">Download PDF</button>
                    <button id="nextButton" type="button" disabled class="btn">Berikutnya</button>

                </div>

            </div>
        </form>
    </div>
</div>
<!-- Modal untuk preview PDF -->
<div id="previewModal" class="modal">
    <div class="modal-content"
        style="position:absolute; top:10%; left:10%; width:80%; height:80%; background:white; padding:10px;">
        <span class="close">&times;</span>
        <button id="customDownloadButton"
  style="position: absolute; top: 10px; right: 50px; background: #0d6efd; color: white; border: none; padding: 6px 12px; border-radius: 5px; font-size: 13px; z-index: 999;">
  <i class="fa fa-download me-1"></i> Download
</button>
        <iframe id="pdfPreview" style="width:100%; height:90%;"></iframe>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  async function loadKota() {
    try {
      const response = await fetch('/data_kota/kota.json');
      const data = await response.json();

      const select = document.getElementById('kota');

      data.forEach(prov => {
        const group = document.createElement('optgroup');
        group.label = prov.provinsi;

        prov.kota.forEach(kota => {
          const option = document.createElement('option');
          option.value = kota;
          option.textContent = kota;
          group.appendChild(option);
        });

        select.appendChild(group);
      });

      // Aktifkan select2 setelah semua option dimuat
      $('#kota').select2({
        placeholder: 'Pilih Kota',
        width: '100%'
      });

    } catch (error) {
      console.error('❌ Gagal memuat data kota:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', loadKota);
</script>


<script>
    let pks_id = null;
    let pdfFilename = null;

    document.addEventListener("DOMContentLoaded", function () {
        const tanggalInput = document.getElementById("tanggal");
        if (tanggalInput) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;
            tanggalInput.setAttribute("min", todayStr); // ⛔ Batasi hanya bisa pilih dari hari ini ke atas
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("multiStepForm");

        if (form) {
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                console.log("⛔ Form submit dicegah.");
            });
        } else {
            console.warn("multiStepForm tidak ditemukan!");
        }
    });

    // pengecekan field 
    document.getElementById("previewButton").addEventListener("click", async function (event) {
        event.preventDefault();

        const form = document.getElementById("multiStepForm");
        const requiredFields = [
            { id: "nomor_pks", label: "Nomor PKS" },
            { id: "hari", label: "Hari" },
            { id: "tanggal", label: "Tanggal" },
            { id: "pt_mitra", label: "PT Mitra" },
            { id: "kota", label: "Kota" },
            { id: "pihak_mitra", label: "Perwakilan dari Mitra" },
            { id: "jabatan", label: "Jabatan" },
            { id: "alamat_pks", label: "Alamat" }
        ];

        let isValid = true;

        // Reset semua error
        requiredFields.forEach(field => {
            const input = document.getElementById(field.id);
            input.style.borderColor = ""; // reset border
            const errorEl = document.getElementById(`${field.id}-error`);
            if (errorEl) errorEl.remove();
        });

        // Validasi per input
        requiredFields.forEach(field => {
            const input = document.getElementById(field.id);
            if (!input.value || input.value === "") {
                isValid = false;
                input.style.borderColor = "red";

                // penambahan pesan error kalau kosong
                const errorText = document.createElement("span");
                errorText.id = `${field.id}-error`;
                errorText.style.color = "red";
                errorText.style.fontSize = "0.8em";
                errorText.textContent = "*Wajib diisi";
                input.parentNode.appendChild(errorText);
            }
        });

        const kategoriCheckboxes = form.querySelectorAll('input[name="kategori[]"]');
        const isKategoriChecked = Array.from(kategoriCheckboxes).some(checkbox => checkbox.checked);

        const kategoriError = document.getElementById("kategori-error");
        if (!isKategoriChecked) {
            isValid = false;
            kategoriError.style.display = "inline";
        } else {
            kategoriError.style.display = "none";
        }

        if (!isValid) {
            return; // Stop kalau tidak valid
        }

        // Jika valid semua, lanjut ke fetch preview PDF
        const formData = new FormData(form);
        const response = await fetch("/admin/dashboardAdmin/preview-pks", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams(formData)
        });

        const data = await response.json();
        if (data.error) {
        Swal.fire({
        icon: "error",
        title: "Gagal Membuat PKS",
        text: data.error || "Terjadi kesalahan saat membuat dokumen.",
        confirmButtonColor: '#d33'
    });
    return;
}

        if (data.pdfPath) {
            document.getElementById("pdfPreview").src = data.pdfPath + "#toolbar=0";
            document.getElementById("previewModal").style.display = "block";
            document.getElementById("downloadButton").disabled = false;

            pks_id = data.pks_id || null;
            pdfFilename = data.pdfFilename || null;  // Simpan nama file PDF untuk tombol Download

            console.log("✅ pks_id tersimpan:", pks_id);
        } else {
            alert("Gagal membuat preview PDF");
        }
    });

    // download button 
    async function handleDownloadPDF(source = "luar") {
        if (!pdfFilename) {
            alert("PDF belum tersedia. Silakan preview ulang.");
            return;
        }

        const formData = new FormData(document.getElementById("multiStepForm"));
        formData.append("pdfFilename", pdfFilename);

        const response = await fetch("/admin/dashboardAdmin/download-pks", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams(formData)
        });

        const data = await response.json();
        if (data.success) {
            Swal.fire({
                toast: true,
                position: 'top',
                icon: 'success',
                title: 'PKS tersimpan ke database',
                showConfirmButton: false,
                timer: 2000,
                background: '#1e293b',
                color: '#ffffff'
            });

            document.getElementById("nextButton").disabled = false;
            pks_id = data.pks_id || null;

            const downloadLink = document.createElement("a");
            downloadLink.href = `/pks_permanen/${pdfFilename}`;
            downloadLink.download = pdfFilename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            if (source === "modal") {
                setTimeout(() => {
                    document.getElementById("previewModal").style.display = "none";
                }, 2200);
            }
        } else {
            alert("Gagal menyimpan PKS: " + data.error);
        }
    }

    // tombol luar modal
    document.getElementById("downloadButton").addEventListener("click", () => handleDownloadPDF("luar"));

    // tombol dalam modal
    document.getElementById("customDownloadButton").addEventListener("click", () => handleDownloadPDF("modal"));

    document.getElementById("nextButton").addEventListener("click", function (event) {
        event.preventDefault();

        // ke halaman upload
        window.location.href = `/admin/dashboard/upload-pks/${pks_id}`;
    });

    // Tutup modal jika mengklik tombol "X"
    document.querySelector(".close").addEventListener("click", function () {
        document.getElementById("previewModal").style.display = "none";
    });

</script>
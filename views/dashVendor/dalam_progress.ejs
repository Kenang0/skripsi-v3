<style>
  .produk-list tbody tr:nth-child(even) {
    background-color: #fceef1;
  }

  .badge-count {
    background-color: #0d6efd;
  }

  .sidebar-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
  }

  .btn-promote {
    background-color: #6c757d;
    color: #fff;
  }

  .btn-promote:hover {
    background-color: #5a6268;
  }

  tr.baris-pemesanan:hover {
    background-color: #7893cf;
    cursor: pointer;
  }

  tr.baris-pemesanan.active {
    background-color: #dbeafe !important;
    font-weight: 600;
    border-left: 4px solid #0d6efd;
  }

  tr.baris-pemesanan {
    transition: background-color 0.3s ease;
  }

  .judul-list {
    border: 1px solid #dee2e6;
    border-bottom: none;
    border-radius: 0.375rem 0.375rem 0 0;
    background: rgb(197, 196, 196);
    padding: 12px 16px;
    font-weight: bold;
  }


  .container-detail {
    max-width: 800px;
    margin: auto;
    border: 1px solid #ccc;
    font-family: Arial, sans-serif;
    font-size: 13px;
    color: #000;
    margin: auto;
    padding: 70px;
    background: #fff;
  }

  .logo-modal {
    width: 140px;
  }

  .flex-space {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  h1 {
    font-size: 20px;
    font-weight: bold;
  }

  .section {
    margin-top: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  th,
  td {
    border: 1px solid #ccc;
    padding: 8px;
    vertical-align: top;
  }

  th {
    background: #f5f5f5;
  }

  .text-right {
    text-align: right;
  }

  .text-bold {
    font-weight: bold;
  }

  .green {
    color: #03AC0E;
  }

  .gray {
    color: #666;
    font-size: 12px;
  }

  .watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.1;
    font-size: 72px;
    color: #999;
    pointer-events: none;
    z-index: 0;
  }

  .footer {
    margin-top: 30px;
    font-size: 12px;
  }

  .placeholder-img {
    width: 100px;
    margin-top: 15px;
  }
</style>

<body class="bg-light">

  <div class="container my-4">
    <div class="row">
      <!-- KIRI -->
      <div class="col-lg-8">
        <h5 class="judul-list">List Permintaan</h5>
        <table class="table produk-list">
          <thead>
            <tr>
              <th>Nama Produk</th>
              <th>Jumlah</th>
              <th>Tanggal</th>
              <th>Pemesan</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% data.forEach((p)=> { %>
              <tr class="baris-pemesanan" data-detail='<%- JSON.stringify({
      id: p.id_pemesanan,
      foto: p.photo_produk || "/uploads/produk_img/default.png",
      masking: p.masking || "-",
      tglStart: new Date(p.tanggal_pengiriman_start).toLocaleDateString("id-ID", { day: "numeric", month: "short", year: "numeric" }),
      tglEnd: new Date(p.tanggal_pengiriman_end).toLocaleDateString("id-ID", { day: "numeric", month: "short", year: "numeric" }),
      jam: p.jam_pengiriman || "-",
      teks: p.teks_iklan_sms || "-",
      nomor_penerima_bukti_tayang: p.nomor_penerima_bukti_tayang || "-",
    }) %>'>
                <td>
                  <%= p.nama_produk %>
                </td>
                <td>
                  <%= p.jumlah_pemesanan %>
                </td>
                <td>
                  <%= new Date(p.tanggal_pemesanan).toLocaleDateString("id-ID", { day: "numeric" , month: "short" ,
                    year: "numeric" }) %>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <img src="<%= p.photo_user || '/uploads/user_foto/default.png' %>" class="rounded-circle me-2"
                      width="30" height="30">
                    <span>
                      <%= p.nama_klien %>
                    </span>
                  </div>
                </td>
                <td>
                  <% if (p.status_pemesanan==="menunggu" ) { %>
                    <span class="badge bg-warning">menunggu</span>
                    <% } else if (p.status_pemesanan==="disetujui" ) { %>
                      <span class="badge bg-success">disetujui</span>
                      <% } else { %>
                        <span class="badge bg-secondary">
                          <%= p.status_pemesanan %>
                        </span>
                        <% } %>
                </td>
              </tr>
              <% }) %>
          </tbody>
        </table>
        
      </div>
      

      <!-- KANAN -->
      <div class="col-lg-4">
        <div id="detailPemesananKanan" class="border rounded bg-white p-3 d-none">
          <h6 class="text-muted mb-3">Preview Pemesanan</h6>
          <div id="konten-detail-kanan" class="small text-dark">
            <!-- Diisi oleh JS -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <% data.forEach((p) => { %>
  <!-- existing <tr> -->
<% }) %>

<!-- MODAL BUKTI PEMESANAN -->
<% data.forEach((p) => { 
  const tglStart = new Date(p.tanggal_pengiriman_start);
  const tglEnd = new Date(p.tanggal_pengiriman_end);
  const sameDate = tglStart.toDateString() === tglEnd.toDateString();
  const options = { day: 'numeric', month: 'long', year: 'numeric' };
%>
<div class="modal fade" id="modalBuktiPemesanan-<%= p.id_pemesanan %>" tabindex="-1" aria-labelledby="modalTitle<%= p.id_pemesanan %>" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle<%= p.id_pemesanan %>">Bukti Pemesanan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        <div class="container-detail">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <img src="/foto/logo_ngiklanmurah.png" style="height: 60px;" alt="Logo-modal">
            <div class="text-end">
              <h5 class="mb-1">BUKTI PEMESANAN</h5>
              <small><strong>NOMOR PEMESANAN:</strong> <%= p.id_pemesanan %></small>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <strong>DITERBITKAN ATAS</strong><br>
              Nama Toko: <strong><%= p.nama_toko_vendor %></strong>
            </div>
            <div class="col-md-6 text-md-end">
              <strong>UNTUK</strong><br>
              Pembeli: <strong><%= p.full_name %></strong><br>
              Tanggal Pemesanan: <%= new Date(p.tanggal_pemesanan).toLocaleDateString("id-ID", options) %><br>
              Nomor Tlp: <%= p.nomor_tlp %><br>
              Email: <%= p.email %>
            </div>
          </div>

          <table class="table table-bordered small mb-4">
            <thead class="table-light">
              <tr>
                <th>INFO PRODUK</th>
                <th>Jenis</th>
                <th>Jumlah</th>
                <th>Harga Satuan</th>
                <th>Total Harga</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <img src="/uploads/produk_img/<%= p.photo_produk %>" class="img-fluid" style="max-height: 80px;"><br>
                  <strong><%= p.nama_produk %></strong>
                </td>
                <td><%= p.tipe_kategori %><br><%= p.jenis_target %></td>
                <td><%= p.jumlah_pemesanan %></td>
                <td>Rp<%= p.harga?.toLocaleString("id-ID") %></td>
                <td>Rp<%= (p.harga * p.jumlah_pemesanan).toLocaleString("id-ID") %></td>
              </tr>
            </tbody>
          </table>

          <!-- DETAIL PEMESANAN -->
          <table class="table table-bordered small mb-4">
            <thead class="table-light text-center">
              <tr><th colspan="2">DETAIL PEMESANAN</th></tr>
            </thead>
            <tbody>
              <tr><td>Nomor Penerima Bukti Tayang</td><td><%= p.nomor_penerima_bukti_tayang || "-" %></td></tr>
              <tr><td>Masking</td><td><%= p.masking || "-" %></td></tr>
              <tr><td>Target Device</td><td><%= p.tipe_device_penerima || "-" %></td></tr>
              <tr><td>Target Umur</td><td><%= p.target_umur || "-" %></td></tr>
              <tr>
                <td>Tanggal Pengiriman</td>
                <td>
                  <% if (sameDate) { %>
                    <%= tglStart.toLocaleDateString("id-ID", options) %>
                  <% } else { %>
                    <%= tglStart.toLocaleDateString("id-ID", options) %> s/d <%= tglEnd.toLocaleDateString("id-ID", options) %>
                  <% } %>
                </td>
              </tr>
              <tr><td>Jam Pengiriman</td><td><%= p.jam_pengiriman %></td></tr>
              <tr><td>Teks Iklan</td><td><%= p.teks_iklan_sms %></td></tr>
            </tbody>
          </table>

          <% if (p.jenis_target?.toLowerCase().includes('mms')){ %>
            <div class="mb-3">
              <strong>Foto MMS:</strong><br>
              <img src="/uploads/sms_files/<%= p.file_foto_mms %>" class="img-fluid" style="max-width: 200px; border: 1px solid #ccc;">
            </div>
          <% } %>

          <% if (p.jenis_target?.toLowerCase().includes('lba')) { %>
            <div class="mb-3">
              <strong>Lokasi Target:</strong><br>
              Latitude: <%= p.dps_latitude %>, Longitude: <%= p.dps_longitude %><br>
              Alamat: <%= p.alamat_target_sms %>
              <div id="map-<%= p.id_pemesanan %>" data-lat="<%= p.dps_latitude %>" data-lng="<%= p.dps_longitude %>" style="height: 300px; margin-top: 10px;"></div>
            </div>
          <% } %>

          <%  if (!p.jenis_target.toLowerCase().includes('lba')) { %>
            <div class="mb-3">
              <strong>File Nomor:</strong><br>
              <iframe src="/uploads/sms_files/<%= p.file_nomor_sms_pdf %>" width="100%" height="400px" style="border: 1px solid #ccc;"></iframe>
            </div>
          <% } %>

          <div class="footer gray mt-4 small text-center text-muted">
            Invoice ini sah dan diproses oleh komputer.<br>
            Hubungi kami jika membutuhkan bantuan lebih lanjut.<br>
            <a href="https://www.tokopedia.com/help">https://www.tokopedia.com/help</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<% }) %>



  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= googleMapsApiKey %>&callback=initMap"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const detailBox = document.getElementById("detailPemesananKanan");
      const kontenBox = document.getElementById("konten-detail-kanan");

      document.querySelectorAll(".baris-pemesanan").forEach(row => {
        row.addEventListener("click", function () {
          // Hapus status 'active' dari semua baris
          document.querySelectorAll(".baris-pemesanan").forEach(r => r.classList.remove("active"));
          this.classList.add("active");

          const data = JSON.parse(this.dataset.detail);

          // Format tanggal pengiriman
          const labelTanggal = (data.tglStart === data.tglEnd)
            ? data.tglStart
            : `${data.tglStart} s/d ${data.tglEnd}`;

          // Isi detail HTML
          const isiHTML = `
          <img src="/uploads/produk_img/${data.foto}" class="img-fluid rounded mb-3" style="max-width: 100%;">
          <div class="table-responsive">
            <table class="table table-bordered small mb-0">
              <tbody>
                <tr>
                  <th scope="row">Masking</th>
                  <td>${data.masking}</td>
                </tr>
                <tr>
                  <th scope="row">No Penerima Bukti Tayang</th>
                  <td>${data.nomor_penerima_bukti_tayang || "-"}</td>
                </tr>
                <tr>
                  <th scope="row">Tanggal Pengiriman</th>
                  <td>${labelTanggal}</td>
                </tr>
                <tr>
                  <th scope="row">Jam Pengiriman</th>
                  <td>${data.jam}</td>
                </tr>
                <tr>
                  <th scope="row">Teks Iklan</th>
                  <td>${data.teks}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between gap-2">
            <a href="#" class="btn btn-outline-secondary btn-sm w-100" data-bs-toggle="modal" data-bs-target="#modalBuktiPemesanan-${data.id}">
              <i class="bi bi-file-earmark-text me-1"></i> Lihat Bukti Pemesanan
            </a>
            <a href="/upload-bukti/${data.id}" class="btn btn-outline-success btn-sm w-100">
              <i class="bi bi-upload me-1"></i> Upload Bukti Tayang
            </a>
          </div>
        `;


          kontenBox.innerHTML = isiHTML;
          detailBox.classList.remove("d-none");
        });
      });
    });
  </script>

  <script>
  function initMap() {
    document.querySelectorAll('[id^="map-"]').forEach(mapEl => {
      const lat = parseFloat(mapEl.dataset.lat);
      const lng = parseFloat(mapEl.dataset.lng);
      const lokasi = { lat, lng };

      const map = new google.maps.Map(mapEl, {
        zoom: 17,
        center: lokasi
      });

      new google.maps.Marker({ position: lokasi, map });
    });
  }
</script>


</body>